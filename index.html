<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IdNix | Unified Identity by CodeNix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); }
        .nix-card { background: linear-gradient(135deg, #4f46e5 0%, #312e81 100%); }
        .hidden-view { display: none !important; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen">

    <!-- Auth View -->
    <div id="auth-view" class="min-h-screen flex flex-col md:flex-row">
        <div class="w-full md:w-1/2 p-12 flex flex-col justify-between bg-gradient-to-br from-indigo-900 via-slate-950 to-black">
            <div>
                <div class="flex items-center space-x-2 mb-8 text-white">
                    <i class="fas fa-microchip text-indigo-500 text-3xl"></i>
                    <span class="text-2xl font-bold tracking-tighter">IdNix</span>
                </div>
                <h1 class="text-5xl md:text-7xl font-extrabold text-white mb-6 leading-tight">
                    One Identity. <br>
                    <span class="text-indigo-500 opacity-80">Infinite</span> Access.
                </h1>
                <p class="text-slate-400 text-xl max-w-md leading-relaxed">
                    Link all your services and information through your unique nixID identifier.
                </p>
            </div>
            <div class="hidden md:block text-slate-500 text-sm">Â© 2024 CodeNix Platform</div>
        </div>

        <div class="w-full md:w-1/2 p-6 md:p-24 flex items-center justify-center bg-slate-950">
            <div class="w-full max-w-md glass border border-slate-800 p-8 rounded-3xl shadow-2xl">
                <div id="auth-form-container">
                    <h2 id="auth-title" class="text-3xl font-bold text-white mb-2">Welcome Back</h2>
                    <p id="auth-subtitle" class="text-slate-400 mb-8">Sign in to access your Nix identity.</p>

                    <form id="auth-form" class="space-y-4">
                        <div id="username-field" class="hidden">
                            <label class="block text-sm font-medium text-slate-400 mb-1">Username</label>
                            <div class="relative">
                                <input type="text" id="username" placeholder="john_doe" class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                                <span class="absolute right-4 top-3 text-slate-500">@nix</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Email</label>
                            <input type="email" id="email" required class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Password</label>
                            <input type="password" id="password" required class="w-full bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div id="auth-error" class="text-red-400 text-sm bg-red-400/10 p-3 rounded-lg border border-red-400/20 hidden"></div>
                        <button type="submit" id="auth-submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-indigo-600/20">
                            Sign In
                        </button>
                    </form>
                    <div class="mt-8 text-center">
                        <button id="toggle-auth" class="text-indigo-400 text-sm font-medium hover:underline">Don't have an ID? Create one</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="hidden-view min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 border-r border-slate-800 flex-col hidden lg:flex bg-slate-950">
            <div class="p-8 flex items-center space-x-2 text-white">
                <i class="fas fa-microchip text-indigo-500"></i>
                <span class="text-xl font-bold tracking-tighter uppercase">IdNix</span>
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <button onclick="showSection('dashboard')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-indigo-600 text-white" id="nav-dashboard">
                    <i class="fas fa-th-large"></i><span>Dashboard</span>
                </button>
                <button onclick="showSection('profile')" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800" id="nav-profile">
                    <i class="fas fa-user"></i><span>My Profile</span>
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button id="signout-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-slate-500 hover:text-red-400">
                    <i class="fas fa-sign-out-alt"></i><span>Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <header class="h-20 border-b border-slate-800 flex items-center justify-between px-8 sticky top-0 bg-slate-950/80 backdrop-blur-md z-20">
                <h2 id="view-title" class="text-xl font-semibold text-white">Overview</h2>
                <div class="flex items-center space-x-4">
                    <div class="text-right hidden sm:block">
                        <p id="header-username" class="text-sm font-bold text-white leading-none">User</p>
                        <p id="header-nixid" class="text-xs text-indigo-400">id@nix</p>
                    </div>
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold border border-indigo-500/50">U</div>
                </div>
            </header>

            <div class="p-8 max-w-6xl mx-auto">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl">
                            <div class="flex justify-between mb-4"><span class="text-slate-400 text-xs font-bold uppercase">Daily Credits</span><i class="fas fa-coins text-emerald-500"></i></div>
                            <div id="stat-credits" class="text-2xl font-bold">100.00 NX</div>
                        </div>
                        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl">
                            <div class="flex justify-between mb-4"><span class="text-slate-400 text-xs font-bold uppercase">Membership</span><i class="fas fa-crown text-amber-500"></i></div>
                            <div id="stat-tier" class="text-2xl font-bold">Pioneer</div>
                        </div>
                        <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl">
                            <div class="flex justify-between mb-4"><span class="text-slate-400 text-xs font-bold uppercase">Linked Apps</span><i class="fas fa-mobile-alt text-indigo-500"></i></div>
                            <div id="stat-apps" class="text-2xl font-bold">1</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="nix-card p-8 rounded-3xl text-white relative overflow-hidden shadow-2xl">
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-12">
                                    <i class="fas fa-microchip text-3xl"></i>
                                    <span class="px-3 py-1 bg-white/20 rounded-full text-[10px] font-bold uppercase">Nix Digital ID</span>
                                </div>
                                <p class="text-indigo-200 text-[10px] uppercase font-bold mb-1">Universal Identifier</p>
                                <h3 id="card-nixid" class="text-3xl font-mono font-bold mb-6 tracking-tight">loading@nix</h3>
                                <div class="flex space-x-12">
                                    <div><p class="text-indigo-200 text-[10px] uppercase font-bold">Status</p><p class="text-sm font-bold"><i class="fas fa-check-circle text-emerald-400 mr-1"></i>Verified</p></div>
                                    <div><p class="text-indigo-200 text-[10px] uppercase font-bold">Issued</p><p class="text-sm font-bold">2024</p></div>
                                </div>
                            </div>
                            <div class="absolute -right-8 -bottom-8 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                        </div>
                        <div class="bg-slate-900 border border-slate-800 p-8 rounded-3xl">
                            <h3 class="text-lg font-bold mb-6"><i class="fas fa-bolt text-indigo-500 mr-2"></i>Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button class="bg-slate-800 p-4 rounded-xl text-left hover:bg-slate-750 border border-slate-700/50"><i class="fas fa-plus-circle text-indigo-400 mb-2 block"></i><span class="text-sm font-bold">Top Up</span></button>
                                <button onclick="showSection('profile')" class="bg-slate-800 p-4 rounded-xl text-left hover:bg-slate-750 border border-slate-700/50"><i class="fas fa-user-edit text-indigo-400 mb-2 block"></i><span class="text-sm font-bold">Edit ID</span></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile-section" class="hidden-view space-y-8">
                    <div class="max-w-2xl bg-slate-900 border border-slate-800 rounded-3xl overflow-hidden">
                        <div class="p-8 border-b border-slate-800">
                            <h3 class="text-xl font-bold">Identity Settings</h3>
                            <p class="text-slate-400 text-sm">Customize your presence across the CodeNix ecosystem.</p>
                        </div>
                        <form id="profile-form" class="p-8 space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div><label class="block text-sm font-medium text-slate-400 mb-2">Full Name</label><input type="text" id="p-fullname" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 outline-none"></div>
                                <div><label class="block text-sm font-medium text-slate-400 mb-2">Location</label><input type="text" id="p-location" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 outline-none"></div>
                            </div>
                            <div><label class="block text-sm font-medium text-slate-400 mb-2">Bio</label><textarea id="p-bio" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 outline-none h-24"></textarea></div>
                            <button type="submit" class="bg-indigo-600 px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all"><i class="fas fa-save mr-2"></i>Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = "https://vnyltfnyuzlfdzjpkzbu.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_fo3B8xkI1AG-u2nJaGK2YQ_LbE5khrC";
        
        // Use a uniquely named global or attachment to window to avoid redeclaration errors
        window.nixSupabase = null;
        let authMode = 'signin';

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the client onto the window object to ensure it persists and avoid 'let' redeclaration issues
            window.nixSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            checkSession();
        });

        // Auth Toggle Logic
        document.getElementById('toggle-auth').addEventListener('click', () => {
            authMode = authMode === 'signin' ? 'signup' : 'signin';
            document.getElementById('auth-title').innerText = authMode === 'signin' ? 'Welcome Back' : 'Join IdNix';
            document.getElementById('auth-subtitle').innerText = authMode === 'signin' ? 'Sign in to access your Nix identity.' : 'Create your unique nixID to start exploring.';
            document.getElementById('auth-submit').innerText = authMode === 'signin' ? 'Sign In' : 'Create Identity';
            document.getElementById('toggle-auth').innerText = authMode === 'signin' ? "Don't have an ID? Create one" : "Already have an ID? Sign in";
            document.getElementById('username-field').classList.toggle('hidden', authMode === 'signin');
        });

        // Handle Login/Signup
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            const errorEl = document.getElementById('auth-error');
            
            errorEl.classList.add('hidden');
            
            try {
                if (authMode === 'signup') {
                    const { error } = await window.nixSupabase.auth.signUp({
                        email, password,
                        options: { data: { username, nix_id: `${username}@nix` } }
                    });
                    if (error) throw error;
                    alert('Signup successful! Please check your email or sign in.');
                } else {
                    const { error } = await window.nixSupabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                }
            } catch (err) {
                errorEl.innerText = err.message;
                errorEl.classList.remove('hidden');
            }
        });

        // Sign Out
        document.getElementById('signout-btn').addEventListener('click', async () => {
            await window.nixSupabase.auth.signOut();
            location.reload();
        });

        async function checkSession() {
            const { data: { session } } = await window.nixSupabase.auth.getSession();
            if (session) {
                document.getElementById('auth-view').classList.add('hidden-view');
                document.getElementById('app-view').classList.remove('hidden-view');
                loadProfile(session.user.id);
            }

            window.nixSupabase.auth.onAuthStateChange((_event, session) => {
                if (session) {
                    document.getElementById('auth-view').classList.add('hidden-view');
                    document.getElementById('app-view').classList.remove('hidden-view');
                    loadProfile(session.user.id);
                }
            });
        }

        async function loadProfile(userId) {
            const { data, error } = await window.nixSupabase.from('profiles').select('*').eq('id', userId).single();
            if (data) {
                document.getElementById('header-username').innerText = data.username;
                document.getElementById('header-nixid').innerText = data.nix_id;
                document.getElementById('card-nixid').innerText = data.nix_id;
                document.getElementById('user-avatar').innerText = data.username[0].toUpperCase();
                document.getElementById('stat-credits').innerText = `${data.credit_balance} NX`;
                document.getElementById('stat-tier').innerText = data.tier;
                document.getElementById('stat-apps').innerText = data.apps_used;

                // Fill profile form
                document.getElementById('p-fullname').value = data.full_name || '';
                document.getElementById('p-location').value = data.location || '';
                document.getElementById('p-bio').value = data.bio || '';
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { data: { session } } = await window.nixSupabase.auth.getSession();
            const updates = {
                full_name: document.getElementById('p-fullname').value,
                location: document.getElementById('p-location').value,
                bio: document.getElementById('p-bio').value
            };
            const { error } = await window.nixSupabase.from('profiles').update(updates).eq('id', session.user.id);
            if (error) alert(error.message);
            else alert('Profile Updated!');
        });

        function showSection(name) {
            document.getElementById('dashboard-section').classList.add('hidden-view');
            document.getElementById('profile-section').classList.add('hidden-view');
            document.getElementById(`${name}-section`).classList.remove('hidden-view');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-slate-400');
            });
            document.getElementById(`nav-${name}`).classList.add('bg-indigo-600', 'text-white');
            document.getElementById('view-title').innerText = name === 'dashboard' ? 'Overview' : 'Settings';
        }
    </script>
</body>
</html>
